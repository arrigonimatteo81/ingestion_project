drop table if exists public.tab_jdbc_sources;

CREATE TABLE public.tab_jdbc_sources (
	source_id varchar NOT NULL,
	url varchar NOT NULL,
	username varchar NOT NULL,
	pwd varchar NOT NULL,
	driver varchar NOT NULL,
	tablename varchar NULL,
	query_text varchar NULL,
	CONSTRAINT check_one_column_populated CHECK ((((tablename IS NOT NULL) AND (query_text IS NULL)) OR ((tablename IS NULL) AND (query_text IS NOT NULL)))),
	CONSTRAINT tab_jdbc_sources_pk PRIMARY KEY (source_id)
);

ALTER TABLE public.tab_jdbc_sources ADD CONSTRAINT fk_tab_jdbc_sources FOREIGN KEY (source_id) REFERENCES public.tab_task_sources(source_id) ON DELETE CASCADE ON UPDATE CASCADE;

GRANT SELECT ON table public.tab_jdbc_sources TO nplg_app;

INSERT INTO public.tab_jdbc_sources
(source_id, url, username, pwd, driver, tablename, query_text)
VALUES
('REAGDG', 'jdbc:sqlserver://pdbclt076.syssede.systest.sanpaoloimi.com\\\\\\\\SYD202:1433;DatabaseName=RDBP0_MENS;encrypt=true;trustServerCertificate=true;integratedSecurity=true;authenticationScheme=NTLM;', 'SYS_LG_RDB@SYSSPIMI', 'SECRET::SYS_LG_RDB@SYSSPIMI', 'com.microsoft.sqlserver.jdbc.SQLServerDriver', NULL,
'SELECT BANCA as NUM_BANCA,LTRIM(RTRIM(NDG)) as COD_NDG,LTRIM(RTRIM(INTESTAZIONE)) as COD_INTESTAZIONE,LTRIM(RTRIM(CODICE_FISCALE)) as COD_FISCALE,LTRIM(RTRIM(COD_TIP_NDG)) as COD_TIP_NDG,LTRIM(RTRIM(COD_PIVA)) as COD_PIVA,LTRIM(RTRIM(COD_STATO_NDG)) as COD_STATO_NDG,LTRIM(RTRIM(COD_SPECIE_GIURIDICA)) as COD_SPECIE_GIURIDICA, LTRIM(RTRIM(COD_UO_CAPOFILA)) as COD_UO_CAPOFILA, LTRIM(RTRIM(DATA_NASC_COST)) as COD_DATA_NASC_COST,LTRIM(RTRIM(COD_COMUNE_NASCITA)) as COD_COMUNE_NASCITA, LTRIM(RTRIM(COD_PROVNC_NASCT_COST)) as COD_PROVNC_NASCT_COST,LTRIM(RTRIM(COD_CAP_RESIDENZA)) as COD_CAP_RESIDENZA, LTRIM(RTRIM(DES_COMUNE_RESIDENZA)) as DES_COMUNE_RESIDENZA,LTRIM(RTRIM(COD_PROVINCIA_RESIDENZA)) as COD_PROVINCIA_RESIDENZA, LTRIM(RTRIM(COD_SOTTOSEGMENTO_ECONOMICO)) as COD_SOTTOSEGMENTO_ECONOMICO,LTRIM(RTRIM(COD_SOTTOSEGMENTO_COMMERCIALE)) as COD_SOTTOSEGMENTO_COMMERCIALE, LTRIM(RTRIM(COD_CLI_NOPROFIT)) as COD_CLI_NOPROFIT,LTRIM(RTRIM(COD_SEGMENTO_ECONOMICO)) as COD_SEGMENTO_ECONOMICO, LTRIM(RTRIM(COD_PTF_CDG)) as COD_PTF_CDG, LTRIM(RTRIM(COD_UTENZA_MODULO)) as COD_UTENZA_MODULO,LTRIM(RTRIM(COD_SEGM_CDG)) as COD_SEGM_CDG, LTRIM(RTRIM(COD_DESK_CLIENTE)) as COD_DESK_CLIENTE, LTRIM(RTRIM(CLASSE_SOA_UO_PTF)) as COD_CLASSE_SOA_UO_PTF,LTRIM(RTRIM(COD_MODULO_CDG)) as COD_MODULO_CDG, LTRIM(RTRIM(COD_GESTORE_REMOTO)) as COD_GESTORE_REMOTO, LTRIM(RTRIM(RIF_REGOLA_DESK)) as COD_RIF_REGOLA_DESK,LTRIM(RTRIM(COD_BU_TERRTRL)) as COD_BU_TERRTRL, LTRIM(RTRIM(COD_TIP_GESTR_GRM)) as COD_TIP_GESTR_GRM, LTRIM(RTRIM(COD_ATECO)) as COD_ATECO,LTRIM(RTRIM(COD_TIP_GESTR_INDUSTRY)) as COD_TIP_GESTR_INDUSTRY, LTRIM(RTRIM(COD_RAE)) as COD_RAE, LTRIM(RTRIM(COD_BU)) as COD_BU, LTRIM(RTRIM(COD_SAE)) as COD_SAE,LTRIM(RTRIM(COD_GRM)) as COD_GRM, LTRIM(RTRIM(COD_SESSO)) as COD_SESSO, LTRIM(RTRIM(COD_UTENZA_GRM)) as COD_UTENZA_GRM,LTRIM(RTRIM(COD_CAPO_INDUSTRY)) as COD_CAPO_INDUSTRY, LTRIM(RTRIM(COD_NDG_PREVLNT)) as COD_NDG_PREVLNT, LTRIM(RTRIM(COD_ABI_SNDG_NDG_PREV)) as COD_ABI_SNDG_NDG_PREV,LTRIM(RTRIM(COD_SNDG_NDG_PREV)) as COD_SNDG_NDG_PREV, LTRIM(RTRIM(FLG_RESIDENTE)) as COD_FLG_RESIDENTE, LTRIM(RTRIM(COD_RILVNZ_ARTCL_136_TUB)) as COD_RILVNZ_ARTCL_136_TUB,LTRIM(RTRIM(COD_RILVNZ_ARTCL_53_TUB)) as COD_RILVNZ_ARTCL_53_TUB, LTRIM(RTRIM(COD_RILVNZ_CONSOB)) as COD_RILVNZ_CONSOB, LTRIM(RTRIM(COD_RILVNZ_IAS_24)) as COD_RILVNZ_IAS_24,LTRIM(RTRIM(COD_NDG_NO_PUSP)) as COD_NDG_NO_PUSP, LTRIM(RTRIM(COD_TIP_GESTN)) as COD_TIP_GESTN, LTRIM(RTRIM(FLG_CAPO_FILR)) as COD_FLG_CAPO_FILR,LTRIM(RTRIM(FLG_APPRTNZ_FILR)) as COD_FLG_APPRTNZ_FILR, LTRIM(RTRIM(COD_SAG)) as COD_SAG, LTRIM(RTRIM(MACRO_CLUSTER_RATING)) as COD_MACRO_CLUSTER_RATING,LTRIM(RTRIM(CLUSTER_RATING)) as COD_CLUSTER_RATING, LTRIM(RTRIM(CLASSE_UNICA_RATING)) as COD_CLASSE_UNICA_RATING, LTRIM(RTRIM(PD_MEDIA)) as COD_PD_MEDIA,LTRIM(RTRIM(PROV_RATING)) as COD_PROV_RATING, LTRIM(RTRIM(COD_COLORE_CLASSE_CRA)) as COD_COLORE_CLASSE_CRA,LTRIM(RTRIM(COD_CLASSE_RATING_PIU_CRA)) as COD_CLASSE_RATING_PIU_CRA, LTRIM(RTRIM(COD_CDN)) as COD_CDN,LTRIM(RTRIM(SEGMENTO_REGOLAMENTARE)) as COD_SEGMENTO_REGOLAMENTARE, LTRIM(RTRIM(SEGMENTO_COMPORTAMENTALE)) as COD_SEGMENTO_COMPORTAMENTALE,LTRIM(RTRIM(FLG_CONDIVISO)) as COD_FLG_CONDIVISO,case when convert(numeric, data_va) <=20000000 then 20010101 else coalesce(convert(numeric, data_va),20010101) end as NUM_DATA_VA,DATA_INS as NUM_DATA_INS,PERIODO_RIF as NUM_PERIODO_RIF, ${num_periodo_rif} as NUM_PERIODO_COMP FROM REAGDG with (nolock) where BANCA=${cod_abi} and case when convert(int, data_va) <=20000000 then 20010101 else coalesce(convert(int, data_va),20010101) end >=${max_data_va}'
),
('READDR', 'jdbc:sqlserver://pdbclt076.syssede.systest.sanpaoloimi.com\\\\\\\\SYD202:1433;DatabaseName=RDBP0_MENS;encrypt=true;trustServerCertificate=true;integratedSecurity=true;authenticationScheme=NTLM;', 'SYS_LG_RDB@SYSSPIMI', 'SECRET::SYS_LG_RDB@SYSSPIMI', 'com.microsoft.sqlserver.jdbc.SQLServerDriver', NULL,
'SELECT BANCA as NUM_BANCA, LTRIM(RTRIM(COD_UO)) as COD_UO,LTRIM(RTRIM(NUM_PARTITA)) as COD_NUM_PARTITA,COD_PROVN_DATI_RED,LTRIM(RTRIM(FORMA_TECNICA)) as COD_FORMA_TECNICA,LTRIM(RTRIM(COD_DIVISA)) as COD_DIVISA,LTRIM(RTRIM(NDG)) as COD_NDG,LTRIM(RTRIM(PTF_RAPPORTO)) as COD_PTF_RAPPORTO, LTRIM(RTRIM(ID_MIGRZ_KTO)) as COD_ID_MIGRZ_KTO,LTRIM(RTRIM(CANALE_VENDITA)) as COD_CANALE_VENDITA,LTRIM(RTRIM(SUB_ID_MIGR_RAPPORTO)) as COD_SUB_ID_MIGR_RAPPORTO,LTRIM(RTRIM(UO_PTF_RAPPORTO)) as COD_UO_PTF_RAPPORTO,LTRIM(RTRIM(COD_STATO_KTO)) as COD_STATO_KTO,LTRIM(RTRIM(COD_PRODOTTO_LEGACY)) as COD_PRODOTTO_LEGACY,LTRIM(RTRIM(COD_PRODOTTO_RAPPORTO)) as COD_PRODOTTO_RAPPORTO,LTRIM(RTRIM(DESK_RAPPORTO)) as COD_DESK_RAPPORTO,LTRIM(RTRIM(COD_RAPP_ANAG)) as COD_RAPP_ANAG,LTRIM(RTRIM(COD_TIP_TASSO)) as COD_TIP_TASSO,(case when LTRIM(RTRIM(DATA_ACCENSIONE))='NA' then 0 else cast(DATA_ACCENSIONE as int) end) as NUM_DATA_ACCENSIONE,(case when LTRIM(RTRIM(DATA_ESTINZIONE)) ='NA' then 0 else cast(DATA_ESTINZIONE as int) end) as NUM_DATA_ESTINZIONE,(case when LTRIM(RTRIM(DATA_SCADENZA))='NA' then 0 else cast(DATA_SCADENZA as int) end) as NUM_DATA_SCADENZA,LTRIM(RTRIM(PTF_SPECCHIO)) as COD_PTF_SPECCHIO,LTRIM(RTRIM(COD_CANALE_PROPOSTA)) as COD_CANALE_PROPOSTA,LTRIM(RTRIM(PRIORITA_DESK_RAPPORTO)) as COD_PRIORITA_DESK_RAPPORTO,LTRIM(RTRIM(DESK_RENDICONTATIVO_RAPPORTO)) as COD_DESK_RENDICONTATIVO_RAPPORTO,LTRIM(RTRIM(PRODOTTO_COMMERCIALE_DINAMICO)) as COD_PRODOTTO_COMMERCIALE_DINAMICO,LTRIM(RTRIM(COD_DIVISIONE)) as COD_DIVISIONE,LTRIM(RTRIM(COD_DIVISIONE_COMMERCIALE)) as COD_DIVISIONE_COMMERCIALE,cast(format(DATAORA_UPD,'yyyyMMddHHmmssfff') as decimal) as NUM_DATA_VA,DATA_INS as NUM_DATA_INS,case when convert(int, periodo_rif) <=200000 then 200101 else coalesce(convert(int, periodo_rif),200101) end as NUM_PERIODO_RIF, {periodo_comp} as NUM_PERIODO_COMP, row_number() over(order by cod_uo, num_partita) as ROW_N from READDR with (nolock) where BANCA={banca_in_elaborazione} and COD_PROVN_DATI_RED = '{provenienza_in_elaborazione}' and DATAORA_UPD >convert(datetime, stuff(stuff(stuff(stuff(cast({max_data_va} as decimal), 9, 0, ' '), 12, 0, ':'), 15, 0, ':'),18,0,'.'))'
)
;